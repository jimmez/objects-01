<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Objects 01 - v02 ‚Äî Objects Slideshow (Commons)</title>
<meta name="description" content="Objects slideshow that fetches random photos from Wikimedia Commons categories per location. Swipe pages reliably (Samsung Internet friendly), seamless image swaps, left-rail controls, auto-apply selection. Defaults: 4s slide, 2s reveal." />
<style>
  :root { --bg:#0b0f14; --fg:#e5eef7; --accent:#60a5fa; --ok:#34d399; --panel:#0f172a; --muted:#9fb7d6; }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial;
    background:var(--bg); color:var(--fg);
    display:grid; grid-template-rows:auto auto 1fr auto;
  }
  header{display:flex; align-items:center; gap:10px; padding:10px 12px; background:#111827; position:sticky; top:0; z-index:1000}
  h1{font-size:16px; margin:0}
  .sp{flex:1}
  .iconBtn{width:36px; height:36px; display:grid; place-items:center; border-radius:10px; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.06); cursor:pointer}
  .badge{font-size:12px; padding:4px 8px; border:1px solid rgba(255,255,255,.12); border-radius:999px}

  nav.tabs{display:flex; gap:8px; padding:8px 12px; border-bottom:1px solid rgba(255,255,255,.06); background:#0f172a; overflow:auto; position:sticky; top:48px; z-index:999}
  .tab{padding:8px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.1); cursor:pointer; white-space:nowrap; background:#0b1222}
  .tab[aria-selected="true"]{background:rgba(96,165,250,.15); border-color:rgba(96,165,250,.6)}
  .page{display:none; height:100%}
  .page.active{display:block}

  /* Stage layout */
  .stageWrap{ display:grid; grid-template-columns:95px 1fr; height:calc(100vh - 210px); min-height:360px; position:relative; }
  @supports(height: 100dvh){ .stageWrap{ height:calc(100dvh - 210px); } }
  .leftRail{
    display:grid; grid-auto-rows:min-content; align-content:start; gap:10px; padding:10px;
    background:rgba(59,130,246,.14); border-right:1px solid rgba(255,255,255,.08); z-index:10; touch-action:none;
  }
  .btn{padding:12px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.1); background:#1f2937; color:#fff; cursor:pointer; font-weight:700}
  .btn.playing{background:rgba(52,211,153,.28); border-color:rgba(52,211,153,.6)}
  #revealBtn, #nextPhoto{height:120px}

  .stage{ position:relative; display:grid; place-items:center; overflow:hidden; }
  .imgwrap{ position:relative; width:100%; height:100%; display:grid; place-items:center; }
  img.photo{ max-width:88vw; max-height:74vh; object-fit:contain; border-radius:16px; box-shadow:0 12px 32px rgba(0,0,0,.55); opacity:0; transition:opacity .18s ease; }
  img.photo.show{opacity:1}

  .nameOverlay{
    position:absolute; left:50%; bottom:6%; transform:translateX(-50%);
    background:rgba(0,0,0,.72); border:1px solid rgba(255,255,255,.1);
    padding:12px 16px; border-radius:14px; text-align:center; max-width:min(92%, 880px)
  }
  .nameOverlay.collapsed{display:none}
  .title{font-size:22px; font-weight:800}
  .tags{margin-top:6px; font-size:13px; color:var(--muted)}

  /* Version tag on page 1 */
  .versionSticker{position:absolute; top:10px; left:110px; z-index:20; background:rgba(0,0,0,.6); border:1px solid rgba(255,255,255,.2); padding:6px 10px; border-radius:10px; font-size:12px}

  .builder{padding:12px}
  .grid{display:grid; grid-template-columns:repeat(auto-fill, minmax(160px, 1fr)); gap:10px}
  .termBtn{padding:12px 14px; border-radius:12px; background:#111827; border:1px solid rgba(255,255,255,.22); cursor:pointer; text-align:left; user-select:none; color:#fff}
  .termBtn.selected{outline:2px solid var(--accent); background:#1f2937}
  .termBtn.editing{outline:2px dashed #fbbf24}
  .rowActions{display:flex; gap:10px; margin-top:10px; flex-wrap:wrap}

  footer{padding:10px 12px; display:flex; flex-wrap:wrap; gap:12px; align-items:center; color:#9fb7d6; background:#111827; z-index:1000}
  footer a{color:var(--ok); text-decoration:none}

  /* Fullscreen swipe catcher for reliable page swipes (Samsung Internet friendly) */
  #swipeCatcher{ position:fixed; inset:0; z-index:998; background:transparent; }
  .noSwipe{ display:none !important; }

  /* Click zones */
  .zonePrev, .zoneNext{ position:absolute; top:0; bottom:0; z-index:5; }
  .zonePrev{ left:95px; width:35%; }
  .zoneNext{ right:0; width:65%; }

  @media (max-width: 768px){ .stageWrap{grid-template-columns:84px 1fr} .zonePrev{ left:84px; } #revealBtn, #nextPhoto{height:100px} }
</style>
</head>
<body>
  <header>
    <h1>üß∞ Objects 01 - v02</h1>
    <span class="badge" id="countBadge">0 photos</span>
    <div class="sp"></div>
    <button class="iconBtn" id="gearBtn" title="Settings (toggle)">‚öôÔ∏è</button>
    <button class="iconBtn" id="openLink" title="Open file page">üîó</button>
  </header>

  <nav class="tabs" role="tablist">
    <button class="tab" role="tab" aria-controls="page1" aria-selected="true" id="tab1">Page 1: Slideshow</button>
    <button class="tab" role="tab" aria-controls="page2" aria-selected="false" id="tab2">Page 2: Locations A</button>
    <button class="tab" role="tab" aria-controls="page3" aria-selected="false" id="tab3">Page 3: Locations B</button>
    <button class="tab" role="tab" aria-controls="page4" aria-selected="false" id="tab4">Page 4: Locations C</button>
    <button class="tab" role="tab" aria-controls="page5" aria-selected="false" id="tab5">Page 5: Settings</button>
  </nav>

  <main>
    <section id="page1" class="page active" role="tabpanel" aria-labelledby="tab1">
      <div class="stageWrap">
        <div class="leftRail">
          <button id="hideAllNames" class="btn">Hide</button>
          <button id="cornerPlayStop" class="btn">‚ñ∂Ô∏è</button>
          <button id="revealBtn" class="btn">Reveal</button>
          <button id="nextPhoto" class="btn">Next</button>
        </div>
        <div class="stage">
          <div class="versionSticker" id="versionSticker">Objects 01 ‚Äî v02</div>
          <div class="imgwrap" id="imgwrap"></div>
          <div class="nameOverlay collapsed" id="nameBar">
            <div class="title" id="entityName">&nbsp;</div>
            <div class="tags" id="entityTags"></div>
          </div>
          <div class="zonePrev" id="zonePrev" title="Previous"></div>
          <div class="zoneNext" id="zoneNext" title="Next"></div>
        </div>
      </div>
      <div id="swipeCatcher" class="noSwipe"></div>
    </section>

    <section id="page2" class="page" role="tabpanel" aria-labelledby="tab2">
      <div class="builder">
        <div class="grid" id="gridLoc1"></div>
        <div class="rowActions"><button class="btn" id="clearAll2">Clear All</button></div>
      </div>
    </section>

    <section id="page3" class="page" role="tabpanel" aria-labelledby="tab3">
      <div class="builder">
        <div class="grid" id="gridLoc2"></div>
        <div class="rowActions"><button class="btn" id="clearAll3">Clear All</button></div>
      </div>
    </section>

    <section id="page4" class="page" role="tabpanel" aria-labelledby="tab4">
      <div class="builder">
        <div class="grid" id="gridLoc3"></div>
        <div class="rowActions"><button class="btn" id="clearAll4">Clear All</button></div>
      </div>
    </section>

    <section id="page5" class="page" role="tabpanel" aria-labelledby="tab5">
      <div class="builder" style="max-width:720px; display:grid; gap:12px">
        <div><strong>Slide speed</strong> (seconds)</div>
        <input id="speedInput" type="number" step="0.2" min="0.2" value="4" />
        <div><strong>Name reveal delay</strong> (seconds)</div>
        <input id="revealInput" type="number" step="0.2" min="0" value="2" />
        <div class="rowActions">
          <button class="btn" id="applySettings">Apply settings</button>
          <span id="settingsNote" style="color:#9fb7d6"></span>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <div>
      PC: <em>Right-side keys</em> ‚áí Next, <em>Left-side keys</em> ‚áí Previous. <kbd>S</kbd> ‚áí Reveal. <kbd>Space</kbd> ‚áí Play/Pause. <kbd>Alt</kbd>+<kbd>C</kbd> ‚áí Clear All.
      Mobile: swipe left/right to switch pages; tap left/right of photo for prev/next. Triple-click a tile to rename.
    </div>
    <div class="sp"></div>
    <a href="#" id="downloadLink" title="Download current image">Download</a>
  </footer>

<script>
(function(){
  /* Tabs / Pages */
  const tabs=[1,2,3,4,5].map(i=>({tab:document.getElementById('tab'+i),page:document.getElementById('page'+i)}));
  const swipeCatcher = document.getElementById('swipeCatcher');

  function activePageIndex(){ return tabs.findIndex(t=> t.page.classList.contains('active')); }
  function setPage(idx){
    tabs.forEach((t,i)=>{
      const on=(i===idx-1);
      t.page.classList.toggle('active', on); t.tab.setAttribute('aria-selected', String(on));
    });
    if(idx===1){ swipeCatcher.classList.remove('noSwipe'); }
    else { swipeCatcher.classList.add('noSwipe'); }
  }
  tabs.forEach((t,i)=> t.tab.addEventListener('click',()=> setPage(i+1)));
  document.getElementById('gearBtn').addEventListener('click', ()=>{ const i=activePageIndex()+1; setPage(i===5?1:5); });

  /* Reliable swipe */
  let sx=0, sy=0, swiping=false;
  swipeCatcher.addEventListener('touchstart', e=>{ if(e.touches.length!==1) return; swiping=true; sx=e.touches[0].clientX; sy=e.touches[0].clientY; }, {passive:false});
  swipeCatcher.addEventListener('touchmove', e=>{ if(!swiping) return; const dx=e.touches[0].clientX - sx; const dy=e.touches[0].clientY - sy; if(Math.abs(dx)>Math.abs(dy)) e.preventDefault(); }, {passive:false});
  swipeCatcher.addEventListener('touchend', e=>{ if(!swiping) return; swiping=false; const t=e.changedTouches[0]; const dx=t.clientX - sx, dy=t.clientY - sy; if(Math.abs(dx)>40 && Math.abs(dy)<60){ const i=activePageIndex()+1; if(dx<0 && i<5) setPage(i+1); if(dx>0 && i>1) setPage(i-1); } }, {passive:false});

  /* Arrow keys for pages */
  document.addEventListener('keydown', (e)=>{
    const tag=(e.target && e.target.tagName)||''; if(tag==='INPUT' || tag==='TEXTAREA') return;
    if(e.key==='ArrowRight'){ const i=activePageIndex()+1; if(i<5) setPage(i+1); }
    if(e.key==='ArrowLeft'){ const i=activePageIndex()+1; if(i>1) setPage(i-1); }
    if(e.altKey && e.key.toLowerCase()==='c'){ e.preventDefault(); clearAll(); }
  });

  /* Locations (expanded, improv-friendly) */
  const LOCATIONS = [
    'Office','Tax office','Restaurant','Doctor\'s office','Hospital','School classroom','University lab','Construction site','Factory floor','Warehouse',
    'Supermarket','Bakery','Home kitchen','Coffee shop','Bar / pub','Theater stage','Film set','Music studio','Art studio','Museum gallery',
    'Library','Gym','Sports stadium','Airport terminal','Train station','Police station','Fire station','Courthouse','Post office','The Moon',
    'Farmer\'s market','School dance','Hardware store','Pharmacy','Beauty salon','Barbershop','Hotel lobby','Kitchen supply store','Flower shop','Public park',
    'Beach','Playground','City street','Subway','Bus stop','Camping site','Garage','Living room','Class reunion','Open mic night'
  ];

  /* Commons category maps for each location. Avoids Wikidata entirely. */
  const MAP_CATS = {
    'Office':[ 'Office_equipment', 'Desks', 'Office_chairs', 'Computers_in_offices', 'Printers', 'Stationery', 'Office_workers', 'Secretaries', 'Delivery_people' ],
    'Tax office':[ 'Office_equipment', 'Counters_(service_areas)', 'Queue_management_systems', 'Forms' ],
    'Restaurant':[ 'Restaurant_equipment', 'Tableware', 'Menus', 'Waiters', 'Chefs', 'Cash_registers' ],
    "Doctor's office":[ 'Medical_equipment', 'Stethoscopes', 'Sphygmomanometers', 'Waiting_rooms', 'Reception_desks' ],
    'Hospital':[ 'Hospital_equipment', 'Operating_rooms', 'Ambulances_(interiors)', 'IV_drips' ],
    'School classroom':[ 'Classrooms', 'Blackboards', 'Whiteboards', 'School_desks', 'School_supplies' ],
    'University lab':[ 'Laboratory_equipment', 'Microscopes', 'Glassware', 'Fume_hoods' ],
    'Construction site':[ 'Construction_tools', 'Excavators', 'Cranes_(machines)', 'Safety_helmets', 'Cones_(traffic)' ],
    'Factory floor':[ 'Industrial_machinery', 'Assembly_lines', 'Conveyor_belts', 'Forklift_trucks' ],
    'Warehouse':[ 'Warehouse_racking', 'Pallets', 'Forklift_trucks', 'Bar_code_scanners' ],
    'Supermarket':[ 'Shopping_carts', 'Shelving', 'Bar_code_scanners', 'Checkout_counters' ],
    'Bakery':[ 'Bakeries', 'Ovens', 'Bread', 'Rolling_pins' ],
    'Home kitchen':[ 'Kitchen_utensils', 'Cookware', 'Refrigerators', 'Cutting_boards' ],
    'Coffee shop':[ 'Espresso_machines', 'Coffee_grinders', 'To_go_cups', 'Baristas' ],
    'Bar / pub':[ 'Bartending_tools', 'Beer_taps', 'Glasses', 'Cocktail_shakers' ],
    'Theater stage':[ 'Stage_lighting_equipment', 'Microphones', 'Props', 'Curtains_(theatre)' ],
    'Film set':[ 'Film_cameras', 'Clapperboards', 'Boom_microphones', 'Light_stands' ],
    'Music studio':[ 'Audio_mixers', 'Headphones', 'Microphones', 'Synthesizers' ],
    'Art studio':[ 'Easels', 'Paintbrushes', 'Palettes', 'Canvases' ],
    'Museum gallery':[ 'Display_cases', 'Audio_guides', 'Gallery_benches' ],
    'Library':[ 'Bookshelves', 'Library_circulation_desks', 'Library_cards' ],
    'Gym':[ 'Dumbbells', 'Treadmills', 'Kettlebells', 'Yoga_mats' ],
    'Sports stadium':[ 'Scoreboards', 'Turnstiles', 'Bleachers', 'Goal_posts' ],
    'Airport terminal':[ 'Check-in_counters', 'Boarding_pass_scanners', 'Baggage_carousels' ],
    'Train station':[ 'Ticket_vending_machines', 'Platforms_(railways)', 'Turnstiles' ],
    'Police station':[ 'Handcuffs', 'Police_radios', 'Evidence_bags' ],
    'Fire station':[ 'Firefighting_equipment', 'Fire_helmets', 'Turnout_gear' ],
    'Courthouse':[ 'Courtrooms', 'Gavels', 'Court_benches' ],
    'Post office':[ 'Mail_sorting', 'Postboxes', 'Scales' ],
    'The Moon':[ 'Apollo_equipment', 'Lunar_samples', 'Space_suits' ],
    "Farmer's market":[ 'Farmers_markets', 'Scales', 'Vegetables', 'Fruit_stalls', 'Cash_boxes' ],
    'School dance':[ 'School_dances', 'Balloon_decorations', 'Disco_balls' ],
    'Hardware store':[ 'Hardware_store_interior', 'Tools', 'Power_tools', 'Fasteners' ],
    'Pharmacy':[ 'Pharmacies', 'Pill_bottles', 'Barcode_scanners', 'Prescription_counters' ],
    'Beauty salon':[ 'Hairdryers', 'Salon_chairs', 'Make-up_tools' ],
    'Barbershop':[ 'Barber_chairs', 'Straight_razors', 'Clippers' ],
    'Hotel lobby':[ 'Reception_desks', 'Luggage_carts', 'Keycards' ],
    'Kitchen supply store':[ 'Cookware', 'Kitchen_knives', 'Bakeware' ],
    'Flower shop':[ 'Florist_tools', 'Bouquets', 'Flower_buckets' ],
    'Public park':[ 'Park_benches', 'Playground_equipment', 'Water_fountains' ],
    'Beach':[ 'Beach_umbrellas', 'Coolers', 'Sunscreen' ],
    'Playground':[ 'Swings', 'Slides', 'Climbing_frames' ],
    'City street':[ 'Street_furniture', 'Newspaper_boxes', 'Traffic_cones' ],
    'Subway':[ 'Turnstiles', 'Ticket_vending_machines', 'Platform_screen_doors' ],
    'Bus stop':[ 'Bus_shelters', 'Timetable_displays', 'Benches' ],
    'Camping site':[ 'Tents', 'Camping_stoves', 'Lanterns' ],
    'Garage':[ 'Tool_chests', 'Car_jacks', 'Air_compressors' ],
    'Living room':[ 'Sofas', 'Coffee_tables', 'Remote_controls' ],
    'Class reunion':[ 'Name_badges', 'Buffets', 'Photo_booths' ],
    'Open mic night':[ 'Microphones', 'Stools', 'PA_systems' ]
  };

  /* Commons API helpers */
  const COMMONS = 'https://commons.wikimedia.org/w/api.php';

  function categoryFetch(category, limit=80){
    const params = new URLSearchParams({
      action:'query', format:'json', origin:'*',
      generator:'categorymembers', gcmtitle:`Category:${category}`,
      gcmtype:'file', gcmlimit:String(Math.min(limit, 200)),
      prop:'imageinfo|info', iiprop:'url', iiurlwidth:'1600', inprop:'url'
    });
    return fetch(`${COMMONS}?${params}`).then(r=>r.json()).then(data=>{
      const pages = data?.query?.pages || {};
      return Object.values(pages).map(p=>{
        const ii = (p.imageinfo||[])[0]||{};
        return {
          key:p.pageid+'' ,
          name:p.title.replace(/^File:/,''),
          imageUrl: ii.thumburl || ii.url,
          fileTitle: p.title,
          itemUrl: p.fullurl || (`https://commons.wikimedia.org/wiki/${encodeURIComponent(p.title)}`),
          tags: []
        };
      });
    }).catch(()=>[]);
  }

  function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }

  async function fetchForLocation(label){
    const cats = MAP_CATS[label] || [];
    if(!cats.length){ return []; }
    const results = await Promise.all(cats.map(c=> categoryFetch(c, 80)));
    const merged = [];
    const seen = new Set();
    for(const list of results){
      for(const it of list){
        if(!it.imageUrl) continue;
        if(seen.has(it.key)) continue;
        seen.add(it.key);
        it.tags = [label];
        merged.push(it);
      }
    }
    return shuffle(merged).slice(0, 160);
  }

  function roundRobin(lists){
    const used=new Set(); const out=[]; const dict=new Map();
    lists.forEach(list=> list.forEach(it=>{ if(!dict.has(it.key)) dict.set(it.key, {...it}); }));
    const queues=lists.map(list=> list.map(it=>it.key));
    const maxLen=Math.max(0,...queues.map(q=>q.length));
    for(let i=0;i<maxLen;i++){
      for(const q of queues){ const k=q[i]; if(k && !used.has(k)){ used.add(k); out.push(dict.get(k)); } }
    }
    return out;
  }

  /* UI refs */
  const gridLoc1=document.getElementById('gridLoc1');
  const gridLoc2=document.getElementById('gridLoc2');
  const gridLoc3=document.getElementById('gridLoc3');
  const countBadge=document.getElementById('countBadge');
  const imgwrap=document.getElementById('imgwrap');
  const nameBar=document.getElementById('nameBar');
  const entityName=document.getElementById('entityName');
  const entityTags=document.getElementById('entityTags');
  const openLinkBtn=document.getElementById('openLink');
  const downloadLink=document.getElementById('downloadLink');

  function setCount(n){ countBadge.textContent = n? `${n} photos` : '0 photos'; }

  function makeTile(label, gridEl){
    const btn=document.createElement('button');
    btn.type='button'; btn.className='termBtn'; btn.textContent=label; btn.dataset.term=label; btn.dataset.clicks='0';
    btn.addEventListener('click', ()=>{
      const c=(+btn.dataset.clicks||0)+1; btn.dataset.clicks=String(c);
      if(c>=3){ // rename
        btn.dataset.clicks='0'; btn.classList.add('editing');
        const prev=btn.dataset.term; const input=document.createElement('input'); input.type='text'; input.value=prev; input.style.width='100%';
        const finish=()=>{ const v=input.value.trim()||prev; btn.dataset.term=v; btn.textContent=v; btn.classList.remove('editing'); autoApply(); };
        input.addEventListener('keydown',(e)=>{ if(e.key==='Enter') finish(); });
        input.addEventListener('blur',finish);
        btn.innerHTML=''; btn.appendChild(input); input.focus(); input.select(); return;
      }
      btn.classList.toggle('selected');
      setTimeout(()=>{ btn.dataset.clicks='0'; }, 280);
      autoApply();
    });
    gridEl.appendChild(btn);
    return btn;
  }

  /* Distribute locations across 3 pages */
  const pages=[gridLoc1,gridLoc2,gridLoc3];
  LOCATIONS.forEach((label, i)=>{ makeTile(label, pages[Math.min(2, Math.floor(i/Math.ceil(LOCATIONS.length/3)))]); });

  /* Selection helpers */
  function selectedFrom(gridEl){ return [...gridEl.querySelectorAll('.termBtn.selected')].map(b=> b.dataset.term||b.textContent.trim()); }
  function selectedAll(){ return { loc:[...selectedFrom(gridLoc1), ...selectedFrom(gridLoc2), ...selectedFrom(gridLoc3)] }; }

  /* Settings */
  let slideSeconds=4, nameDelay=2000;
  document.getElementById('applySettings').onclick=()=>{
    slideSeconds=Math.max(0.2, +document.getElementById('speedInput').value||4);
    nameDelay=Math.max(0, (+document.getElementById('revealInput').value||2)*1000);
    document.getElementById('settingsNote').textContent=`Applied: slide ${slideSeconds.toFixed(1)}s, reveal ${(nameDelay/1000).toFixed(1)}s.`;
    if(autoplay) startAutoplay();
  };

  /* Fetch + mix */
  let items=[]; let currIndex=-1; let autoplay=false; let timer=null; let currentLink='#';
  function debounce(fn, ms=350){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
  const autoApply = debounce(applySelection, 250);
  let fetchGen=0;

  async function applySelection(){
    const sel=selectedAll();
    const gen=++fetchGen;
    const perList=[];
    const chosen = sel.loc.length? sel.loc : ['Office'];
    for(const label of chosen){
      try{
        const rows = await fetchForLocation(label);
        if(gen!==fetchGen) return;
        perList.push(rows);
      }catch(e){ console.warn('fetch failed', label, e); }
    }
    const mixed=roundRobin(perList);
    if(gen!==fetchGen) return;
    items=mixed; setCount(items.length);
    if(!items.length){ imgwrap.innerHTML=''; return; }
    currIndex=-1; setPage(1); showIndex(0); startAutoplay();
  }

  /* Slideshow */
  let currentImg=null; let globalHide=false; let perSlideReveal=false;
  function swapIn(img){
    const prev=currentImg; currentImg=img; currentImg.classList.add('photo','show');
    imgwrap.appendChild(currentImg);
    if(prev){ prev.addEventListener('transitionend', ()=>{ try{ imgwrap.removeChild(prev); }catch{} }, {once:true}); prev.classList.remove('show'); }
  }

  function showIndex(i){
    if(!items.length) return;
    currIndex=(i+items.length)%items.length;
    const it=items[currIndex];
    const img=new Image(); img.decoding='async'; img.referrerPolicy='no-referrer';
    img.onload=()=>{
      swapIn(img);
      entityName.textContent=it.name;
      entityTags.textContent=(it.tags||[]).join(' + ');
      nameBar.classList.add('collapsed');
      currentLink = it.itemUrl || '#';
      setTimeout(()=>{ if(!globalHide || perSlideReveal){ nameBar.classList.remove('collapsed'); } perSlideReveal=false; }, nameDelay);
      downloadLink.href=it.imageUrl; downloadLink.download=it.fileTitle.replace(/^File:/,'');
    };
    img.onerror=()=>{ console.warn('image failed, skipping'); next(); };
    img.src=it.imageUrl;
  }
  function next(){ showIndex((currIndex+1)%items.length); }
  function prev(){ showIndex((currIndex-1+items.length)%items.length); }

  /* Controls */
  const playBtn=document.getElementById('cornerPlayStop');
  const hideBtn=document.getElementById('hideAllNames');
  const revealBtn=document.getElementById('revealBtn');
  const nextBtn=document.getElementById('nextPhoto');

  function startAutoplay(){ if(timer) clearInterval(timer); timer=setInterval(next, (slideSeconds||2)*1000); autoplay=true; playBtn.textContent='‚èπ'; playBtn.classList.add('playing'); }
  function stopAutoplay(){ if(timer) clearInterval(timer); timer=null; autoplay=false; playBtn.textContent='‚ñ∂Ô∏è'; playBtn.classList.remove('playing'); }

  playBtn.onclick=()=> autoplay? stopAutoplay():startAutoplay();
  hideBtn.onclick=()=>{ globalHide=!globalHide; nameBar.classList.toggle('collapsed', globalHide); hideBtn.textContent=globalHide?'Show':'Hide'; };
  revealBtn.onclick=()=>{ perSlideReveal=true; nameBar.classList.remove('collapsed'); };
  nextBtn.onclick=()=>{ stopAutoplay(); next(); };
  openLinkBtn.onclick=()=>{ if(currentLink && currentLink!=='#') window.open(currentLink,'_blank','noopener'); };

  document.getElementById('zonePrev').addEventListener('click', ()=>{ stopAutoplay(); prev(); });
  document.getElementById('zoneNext').addEventListener('click', ()=>{ stopAutoplay(); next(); });

  /* PC keyboard mapping for slides */
  document.addEventListener('keydown', (e)=>{
    const tag=(e.target && e.target.tagName)||''; if(tag==='INPUT' || tag==='TEXTAREA') return;
    const key=(e.key||'').toLowerCase();
    if(e.code==='Space'){ e.preventDefault(); autoplay? stopAutoplay():startAutoplay(); return; }
    if(key==='s'){ e.preventDefault(); perSlideReveal=true; nameBar.classList.remove('collapsed'); return; }
    const leftSet=new Set(['`','1','2','3','4','5','q','w','e','r','t','a','s','d','f','g','z','x','c','v','b']);
    const rightSet=new Set(['6','7','8','9','0','-','=', 'y','u','i','o','p','[',']','\\', 'h','j','k','l',';','\'', 'n','m',',','.','/']);
    if(rightSet.has(key)){ stopAutoplay(); next(); return; }
    if(leftSet.has(key)){ stopAutoplay(); prev(); return; }
  });

  /* Clear All shared */
  function clearAll(){
    document.querySelectorAll('.termBtn.selected').forEach(b=> b.classList.remove('selected'));
    items=[]; currIndex=-1; setCount(0); stopAutoplay(); imgwrap.innerHTML='';
  }
  document.getElementById('clearAll2').onclick=clearAll;
  document.getElementById('clearAll3').onclick=clearAll;
  document.getElementById('clearAll4').onclick=clearAll;

  /* Boot: preselect Office + apply */
  const allTiles=[...document.querySelectorAll('#gridLoc1 .termBtn,#gridLoc2 .termBtn,#gridLoc3 .termBtn')];
  // If tiles not yet created (because of timing), wait a tick
  setTimeout(()=>{
    const officeBtn=[...document.querySelectorAll('#gridLoc1 .termBtn,#gridLoc2 .termBtn,#gridLoc3 .termBtn')].find(b=> (b.dataset.term||b.textContent)==='Office');
    if(officeBtn) officeBtn.classList.add('selected');
    applySelection();
  }, 0);
})();
</script>
</body>
</html>
